‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à 100% ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ (Technical Documentation) ‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° Code, API Specification ‡πÅ‡∏•‡∏∞ Logic ‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏° Developer ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö

---

# üìò Bosun IoT Integration Documentation

**Version:** 1.0 (Stable - Hybrid Auth)
**Last Updated:** December 2025

## 1\. System Overview (‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö)

‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Bosun IoT Platform ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ö‡∏ö **Hybrid Authentication** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡πâ‡∏≤‡∏ß‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á API ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

1.  **Read Operations (Monitoring):** ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô **Enterprise API (RSA Signed)** ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏™‡∏π‡∏á Token ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
2.  **Write Operations (Control):** ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ **Browser Session Mimic** (‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö) ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å Enterprise API ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á Control ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
3.  **Real-time Update:** ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ **Active Monitoring** (‡∏™‡∏±‡πà‡∏á Refresh ‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô -\> ‡∏£‡∏≠ -\> ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

---

## 2\. Project Structure (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå)

‡∏Ñ‡∏ß‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

```text
project_root/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ private_key.pem       # RSA Private Key (‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥‡∏´‡∏≤‡∏¢)
‚îÇ   ‚îî‚îÄ‚îÄ token_cache.json      # Auto-generated by bs_auth.py
‚îú‚îÄ‚îÄ bs_auth.py                # Module: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Enterprise Token & Auto-Renew
‚îú‚îÄ‚îÄ bs_decoder.py             # Module: Logic ‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ v13 (Hex -> Readable Data)
‚îú‚îÄ‚îÄ bs_controller_with_auth.py # Script: ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô (ON/OFF/Refresh) ‡πÉ‡∏ä‡πâ Browser Token
‚îî‚îÄ‚îÄ bs_monitor_active.py      # Script: ‡∏£‡∏∞‡∏ö‡∏ö Monitor ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Refresh -> Read Loop)
```

---

## 3\. Decoder Specification (v13 Logic)

‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ Logic ‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ Hex String ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ 100% (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏î Header `010390` ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ 6 ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß)

**Hex String Payload Offset Map:**

| Parameter            | Position (Start Index) | Length (Hex Chars) | Divisor | Unit | Description             |
| :------------------- | :--------------------: | :----------------: | :-----: | :--: | :---------------------- |
| **Current**          |           4            |         4          |   100   |  A   | ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÑ‡∏ü‡∏ü‡πâ‡∏≤              |
| **Voltage**          |           20           |         4          |   10    |  V   | ‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤             |
| **Frequency**        |           28           |         4          |   100   |  Hz  | ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà                 |
| **Active Power**     |           36           |         4          |   100   |  W   | ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á          |
| **Energy**           |           60           |         4          |  1000   | kWh  | ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏∞‡∏™‡∏°             |
| **Light Intensity**  |           72           |         4          |    1    | Lux  | ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏™‡∏á (Photocell) |
| **Power Factor**     |          100           |         4          |   100   |  PF  | ‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á       |
| **Tilt Sensitivity** |          104           |         4          |    1    |  -   | ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏≠‡∏µ‡∏¢‡∏á            |
| **Brightness**       |          120           |         8          |    1    |  %   | ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á          |
| **Temperature**      |          264           |         4          |   100   |  ¬∞C  | ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥                |
| **Humidity**         |          268           |         4          |   100   |  %   | ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô                |

**Example Decode Logic (Python):**

```python
# Raw Value (Base 16) / Divisor = Actual Value
voltage = int(hex_string[20:24], 16) / 10
```

---

## 4\. API Reference (Unofficial)

### A. Authentication (Enterprise)

‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≠ Token ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Listing/Reading)

- **Endpoint:** `POST http://open.smartbosun.com:8000/api/v1/access_token`
- **Method:** RSA-SHA256 Signature
- **Libraries Required:** `cryptography`
- **Output:** Access Token (‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏±‡πâ‡∏ô ‡∏ï‡πâ‡∏≠‡∏á Renew ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ ‡∏ã‡∏∂‡πà‡∏á `bs_auth.py` ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß)

### B. Device Control (Browser Mimic)

‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏±‡πà‡∏á ON/OFF ‡πÅ‡∏•‡∏∞ Force Refresh **(API ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Browser Token)**

- **Endpoint:** `POST https://light.smartbosun.com/api/mqtt?project_id={PROJECT_ID}`
- **Headers (Required):**
  ```json
  {
    "Authorization": "Bearer {BROWSER_TOKEN}",
    "Content-Type": "application/json",
    "Referer": "https://light.smartbosun.com/",
    "User-Agent": "Mozilla/5.0..."
  }
  ```
- **Payload Structure:**
  ```json
  {
    "msgs": [{
      "topic": "BS_Sev/{DEVICE_ID}",
      "qos": 0,
      "payload": { "CMD": {CMD_CODE}, "D": "{DATA_STRING}" }
    }]
  }
  ```

#### **Command Reference Table**

| Action       | CMD Code | Data String (D) Pattern | Note                                |
| :----------- | :------: | :---------------------- | :---------------------------------- |
| **Turn ON**  |    20    | `...0064AE28`           | ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü (Brightness 100%)        |
| **Turn OFF** |    21    | `...0000AFC3`           | ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡πÑ‡∏ü                           |
| **Refresh**  |    21    | `...01030044004805E9`   | ‡∏™‡∏±‡πà‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ (Read Holding Register) |

_‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: `...` ‡∏Ñ‡∏∑‡∏≠ Device ID ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ 000... (‡∏î‡∏π Code ‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ô `bs_controller_with_auth.py`)_

---

## 5\. Maintenance Guide (‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤)

‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏™‡∏π‡∏á ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏• 1 ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:

### ‚ö†Ô∏è Browser Token Expiry

Token ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå `bs_controller_with_auth.py` ‡πÅ‡∏•‡∏∞ `bs_monitor_active.py` ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

- **‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:** **30 ‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô 2025** (‡∏õ‡∏µ‡∏´‡∏ô‡πâ‡∏≤)
- **‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:**
  1.  Login ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö Bosun Platform
  2.  ‡∏Å‡∏î F12 -\> Network Tab
  3.  ‡∏Å‡∏î‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  4.  Copy `Authorization: Bearer ...` ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤
  5.  ‡∏ô‡∏≥‡∏°‡∏≤‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ `BROWSER_TOKEN` ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Python

### ‚ö†Ô∏è API Rate Limiting

- ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå `bs_monitor_active.py` ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á `POLL_INTERVAL = 5` ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
- **‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Server ‡∏°‡∏≠‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ (DDoS) ‡πÅ‡∏•‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å IP

---

## 6\. Code Snippets (Core Logic)

### 6.1 `bs_decoder.py` (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤)

‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ Library ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡∏° Dev ‡∏Ñ‡∏ß‡∏£ Import ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ

```python
# ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô
import bs_decoder as decoder

# 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
device_data = decoder.get_device_data()
# 2. ‡πÅ‡∏õ‡∏•‡∏á Hex
hex_str = decoder.extract_hex(device_data)
# 3. ‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏õ‡πá‡∏ô Dictionary
result = decoder.decode_final(hex_str)

print(f"Current Power: {result['power_w']} W")
```

### 6.2 `bs_monitor_active.py` (Workflow ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)

Logic ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Loop ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå:

1.  **Poke:** ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Refresh (CMD 21 + Read Payload)
2.  **Wait:** ‡∏£‡∏≠ 2-3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Server Update DB)
3.  **Read:** ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô Enterprise API
4.  **Display:** ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•

---

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Dashboard ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á, ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö Log ‡∏•‡∏á Database)
